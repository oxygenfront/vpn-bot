generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins"]
}

enum Status {
  Cancelled
  Active
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String             @id @unique
  telegramId    String             @unique
  username      String?
  cardToken     String
  langCode      String             @default("ru")
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  subscriptions UserSubscription[]
}

model Plan {
  id                Int                @id @default(autoincrement())
  name              String             @unique
  trafficLimit      String
  subscriptionPlans SubscriptionPlan[]
}

model DeviceRange {
  id                Int                @id @default(autoincrement())
  range             String             @unique
  subscriptionPlans SubscriptionPlan[]
}

model SubscriptionPlan {
  id                Int                @id @default(autoincrement())
  planId            Int
  deviceRangeId     Int
  months            Int
  price             Float
  plan              Plan               @relation(fields: [planId], references: [id])
  deviceRange       DeviceRange        @relation(fields: [deviceRangeId], references: [id])
  userSubscriptions UserSubscription[]

  @@unique([planId, deviceRangeId, months])
}

model UserSubscription {
  id                  String           @id @unique
  userId              String
  startBillingDate    DateTime
  nextBillingDate     DateTime
  expiredDate         DateTime
  lastInvoiceId       String
  status              Status
  vlessLinkConnection String
  urlLinkConnection   String
  subscriptionPlanId  Int
  user                User             @relation(fields: [userId], references: [id])
  subscriptionPlan    SubscriptionPlan @relation(fields: [subscriptionPlanId], references: [id])

  @@index([userId])
}
